'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.processTemplate = processTemplate;
exports.replaceTemplate = replaceTemplate;

var _immutable = require('immutable');

var _ramda = require('ramda');

var _ramda2 = _interopRequireDefault(_ramda);

var _syntax = require('./syntax');

var _syntax2 = _interopRequireDefault(_syntax);

var _errors = require('./errors');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
Given a syntax list like:

  [foo, bar, $, { 42, +, 24 }, baz]

convert it to:

  [foo, bar, $, { 0 }, baz]

and return another list with the interpolated values at the corresponding
positions.

Requires either lookahead/lookbehind of one (to see the $).
*/

const isDolar = s => s && typeof s.match === 'function' && s.match("identifier") && s.val() === '$';
const isDelimiter = s => s && typeof s.match === 'function' && s.match("delimiter");
const isBraces = s => s && typeof s.match === 'function' && s.match("braces");
const isParens = s => s && typeof s.match === 'function' && s.match("parens");
const isBrackets = s => s && typeof s.match === 'function' && s.match("brackets");

const insertIntoDelimiter = _ramda2.default.cond([[isBraces, (s, r) => _syntax2.default.from("braces", r, s)], [isParens, (s, r) => _syntax2.default.from("parens", r, s)], [isBrackets, (s, r) => _syntax2.default.from("brackets", r, s)]]);

const process = (acc, s) => {
  if (isBraces(s) && isDolar(acc.template.last())) {
    return {
      template: acc.template.push(_syntax2.default.from("braces", _immutable.List.of(_syntax2.default.from("number", acc.interp.size)), s)),
      interp: acc.interp.push(s.inner())
    };
  } else if (isDelimiter(s)) {
    let innerResult = processTemplate(s.inner(), acc.interp);
    return {
      template: acc.template.push(insertIntoDelimiter(s, innerResult.template)),
      interp: innerResult.interp
    };
  } else {
    return {
      template: acc.template.push(s),
      interp: acc.interp
    };
  }
};

function cloneLineNumber(to, from) {
  if (from && to) {
    if (typeof to.setLineNumber === 'function') {
      return to.setLineNumber(from.lineNumber());
    } else if (_immutable.List.isList(to)) {
      return to.map(x => cloneLineNumber(x, from));
    }
  }
  return to;
}

const replace = (acc, s) => {
  let last = acc.template.get(-1);
  let beforeLast = acc.template.get(-2);
  if (isBraces(s) && isDolar(last)) {
    let index = s.inner().first().val();
    (0, _errors.assert)(acc.rep.size > index, "unknown replacement value");
    let replacement = cloneLineNumber(acc.rep.get(index), beforeLast);
    return {
      template: acc.template.pop().concat(replacement),
      rep: acc.rep
    };
  } else if (isDelimiter(s)) {
    let innerResult = replaceTemplate(s.inner(), acc.rep);
    return {
      template: acc.template.push(insertIntoDelimiter(s, innerResult)),
      rep: acc.rep
    };
  } else {
    return {
      template: acc.template.push(s),
      rep: acc.rep
    };
  }
};

function processTemplate(temp) {
  let interp = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : (0, _immutable.List)();

  return temp.reduce(process, { template: (0, _immutable.List)(), interp: interp });
}

function replaceTemplate(temp, rep) {
  return temp.reduce(replace, { template: (0, _immutable.List)(), rep: rep }).template;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZW1wbGF0ZS1wcm9jZXNzb3IuanMiXSwibmFtZXMiOlsicHJvY2Vzc1RlbXBsYXRlIiwicmVwbGFjZVRlbXBsYXRlIiwiaXNEb2xhciIsInMiLCJtYXRjaCIsInZhbCIsImlzRGVsaW1pdGVyIiwiaXNCcmFjZXMiLCJpc1BhcmVucyIsImlzQnJhY2tldHMiLCJpbnNlcnRJbnRvRGVsaW1pdGVyIiwiY29uZCIsInIiLCJmcm9tIiwicHJvY2VzcyIsImFjYyIsInRlbXBsYXRlIiwibGFzdCIsInB1c2giLCJvZiIsImludGVycCIsInNpemUiLCJpbm5lciIsImlubmVyUmVzdWx0IiwiY2xvbmVMaW5lTnVtYmVyIiwidG8iLCJzZXRMaW5lTnVtYmVyIiwibGluZU51bWJlciIsImlzTGlzdCIsIm1hcCIsIngiLCJyZXBsYWNlIiwiZ2V0IiwiYmVmb3JlTGFzdCIsImluZGV4IiwiZmlyc3QiLCJyZXAiLCJyZXBsYWNlbWVudCIsInBvcCIsImNvbmNhdCIsInRlbXAiLCJyZWR1Y2UiXSwibWFwcGluZ3MiOiI7Ozs7O1FBd0ZnQkEsZSxHQUFBQSxlO1FBSUFDLGUsR0FBQUEsZTs7QUE1RmhCOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7Ozs7Ozs7Ozs7Ozs7QUFlQSxNQUFNQyxVQUFjQyxLQUFLQSxLQUFLLE9BQU9BLEVBQUVDLEtBQVQsS0FBbUIsVUFBeEIsSUFBc0NELEVBQUVDLEtBQUYsQ0FBUSxZQUFSLENBQXRDLElBQStERCxFQUFFRSxHQUFGLE9BQVksR0FBcEc7QUFDQSxNQUFNQyxjQUFjSCxLQUFLQSxLQUFLLE9BQU9BLEVBQUVDLEtBQVQsS0FBbUIsVUFBeEIsSUFBc0NELEVBQUVDLEtBQUYsQ0FBUSxXQUFSLENBQS9EO0FBQ0EsTUFBTUcsV0FBY0osS0FBS0EsS0FBSyxPQUFPQSxFQUFFQyxLQUFULEtBQW1CLFVBQXhCLElBQXNDRCxFQUFFQyxLQUFGLENBQVEsUUFBUixDQUEvRDtBQUNBLE1BQU1JLFdBQWNMLEtBQUtB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K0JKLEdBQS9CLEVBQW9DO0FBQ3pDLFNBQU9JLEtBQUtDLE1BQUwsQ0FBWVYsT0FBWixFQUFxQixFQUFFZixVQUFVLHNCQUFaLEVBQW9Cb0IsUUFBcEIsRUFBckIsRUFBZ0RwQixRQUF2RDtBQUNEIiwiZmlsZSI6InRlbXBsYXRlLXByb2Nlc3Nvci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExpc3QgfSBmcm9tICdpbW11dGFibGUnO1xuaW1wb3J0IF8gZnJvbSAncmFtZGEnO1xuaW1wb3J0IFN5bnRheCBmcm9tICcuL3N5bnRheCc7XG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tICcuL2Vycm9ycyc7XG5cbi8qXG5HaXZlbiBhIHN5bnRheCBsaXN0IGxpa2U6XG5cbiAgW2ZvbywgYmFyLCAkLCB7IDQyLCArLCAyNCB9LCBiYXpdXG5cbmNvbnZlcnQgaXQgdG86XG5cbiAgW2ZvbywgYmFyLCAkLCB7IDAgfSwgYmF6XVxuXG5hbmQgcmV0dXJuIGFub3RoZXIgbGlzdCB3aXRoIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWVzIGF0IHRoZSBjb3JyZXNwb25kaW5nXG5wb3NpdGlvbnMuXG5cblJlcXVpcmVzIGVpdGhlciBsb29rYWhlYWQvbG9va2JlaGluZCBvZiBvbmUgKHRvIHNlZSB0aGUgJCkuXG4qL1xuXG5jb25zdCBpc0RvbGFyICAgICA9IHMgPT4gcyAmJiB0eXBlb2Ygcy5tYXRjaCA9PT0gJ2Z1bmN0aW9uJyAmJiBzLm1hdGNoKFwiaWRlbnRpZmllclwiKSAmJiBzLnZhbCgpID09PSAnJCc7XG5jb25zdCBpc0RlbGltaXRlciA9IHMgPT4gcyAmJiB0eXBlb2Ygcy5tYXRjaCA9PT0gJ2Z1bmN0aW9uJyAmJiBzLm1hdGNoKFwiZGVsaW1pdGVyXCIpO1xuY29uc3QgaXNCcmFjZXMgICAgPSBzID0+IHMgJiYgdHlwZW9mIHMubWF0Y2ggPT09ICdmdW5jdGlvbicgJiYgcy5tYXRjaChcImJyYWNlc1wiKTtcbmNvbnN0IGlzUGFyZW5zICAgID0gcyA9PiBzICYmIHR5cGVvZiBzLm1hdGNoID09PSAnZnVuY3Rpb24nICYmIHMubWF0Y2goXCJwYXJlbnNcIik7XG5jb25zdCBpc0JyYWNrZXRzICA9IHMgPT4gcyAmJiB0eXBlb2Ygcy5tYXRjaCA9PT0gJ2Z1bmN0aW9uJyAmJiBzLm1hdGNoKFwiYnJhY2tldHNcIik7XG5cbmNvbnN0IGluc2VydEludG9EZWxpbWl0ZXIgPSBfLmNvbmQoW1xuICBbaXNCcmFjZXMsIChzLCByKSA9PiBTeW50YXguZnJvbShcImJyYWNlc1wiLCByLCBzKV0sXG4gIFtpc1BhcmVucywgKHMsIHIpID0+IFN5bnRheC5mcm9tKFwicGFyZW5zXCIsIHIsIHMpXSxcbiAgW2lzQnJhY2tldHMsIChzLCByKSA9PiBTeW50YXguZnJvbShcImJyYWNrZXRzXCIsIHIsIHMpXVxuXSk7XG5cbmNvbnN0IHByb2Nlc3MgPSAoYWNjLCBzKSA9PiB7XG4gIGlmIChpc0JyYWNlcyhzKSAmJiBpc0RvbGFyKGFjYy50ZW1wbGF0ZS5sYXN0KCkpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRlbXBsYXRlOiBhY2MudGVtcGxhdGUucHVzaChTeW50YXguZnJvbShcImJyYWNlc1wiLCBMaXN0Lm9mKFN5bnRheC5mcm9tKFwibnVtYmVyXCIsIGFjYy5pbnRlcnAuc2l6ZSkpLCBzKSksXG4gICAgICBpbnRlcnA6IGFjYy5pbnRlcnAucHVzaChzLmlubmVyKCkpXG4gICAgfTtcbiAgfSBlbHNlIGlmIChpc0RlbGltaXRlcihzKSkge1xuICAgIGxldCBpbm5lclJlc3VsdCA9IHByb2Nlc3NUZW1wbGF0ZShzLmlubmVyKCksIGFjYy5pbnRlcnApO1xuICAgIHJldHVybiB7XG4gICAgICB0ZW1wbGF0ZTogYWNjLnRlbXBsYXRlLnB1c2goaW5zZXJ0SW50b0RlbGltaXRlcihzLCBpbm5lclJlc3VsdC50ZW1wbGF0ZSkpLFxuICAgICAgaW50ZXJwOiBpbm5lclJlc3VsdC5pbnRlcnBcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB7XG4gICAgICB0ZW1wbGF0ZTogYWNjLnRlbXBsYXRlLnB1c2gocyksXG4gICAgICBpbnRlcnA6IGFjYy5pbnRlcnBcbiAgICB9O1xuICB9XG59O1xuXG5mdW5jdGlvbiBjbG9uZUxpbmVOdW1iZXIodG8sIGZyb20pIHtcbiAgaWYgKGZyb20gJiYgdG8gKSB7XG4gICAgaWYgKHR5cGVvZiB0by5zZXRMaW5lTnVtYmVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXR1cm4gdG8uc2V0TGluZU51bWJlcihmcm9tLmxpbmVOdW1iZXIoKSk7XG4gICAgfSBlbHNlIGlmIChMaXN0LmlzTGlzdCh0bykpIHtcbiAgICAgIHJldHVybiB0by5tYXAoeCA9PiBjbG9uZUxpbmVOdW1iZXIoeCwgZnJvbSkpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdG87XG59XG5cbmNvbnN0IHJlcGxhY2UgPSAoYWNjLCBzKSA9PiB7XG4gIGxldCBsYXN0ID0gYWNjLnRlbXBsYXRlLmdldCgtMSk7XG4gIGxldCBiZWZvcmVMYXN0ID0gYWNjLnRlbXBsYXRlLmdldCgtMik7XG4gIGlmIChpc0JyYWNlcyhzKSAmJiBpc0RvbGFyKGxhc3QpKSB7XG4gICAgbGV0IGluZGV4ID0gcy5pbm5lcigpLmZpcnN0KCkudmFsKCk7XG4gICAgYXNzZXJ0KGFjYy5yZXAuc2l6ZSA+IGluZGV4LCBcInVua25vd24gcmVwbGFjZW1lbnQgdmFsdWVcIik7XG4gICAgbGV0IHJlcGxhY2VtZW50ID0gY2xvbmVMaW5lTnVtYmVyKGFjYy5yZXAuZ2V0KGluZGV4KSwgYmVmb3JlTGFzdCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRlbXBsYXRlOiBhY2MudGVtcGxhdGUucG9wKCkuY29uY2F0KHJlcGxhY2VtZW50KSxcbiAgICAgIHJlcDogYWNjLnJlcFxuICAgIH07XG4gIH0gZWxzZSBpZiAoaXNEZWxpbWl0ZXIocykpIHtcbiAgICBsZXQgaW5uZXJSZXN1bHQgPSByZXBsYWNlVGVtcGxhdGUocy5pbm5lcigpLCBhY2MucmVwKTtcbiAgICByZXR1cm4ge1xuICAgICAgdGVtcGxhdGU6IGFjYy50ZW1wbGF0ZS5wdXNoKGluc2VydEludG9EZWxpbWl0ZXIocywgaW5uZXJSZXN1bHQpKSxcbiAgICAgIHJlcDogYWNjLnJlcFxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRlbXBsYXRlOiBhY2MudGVtcGxhdGUucHVzaChzKSxcbiAgICAgIHJlcDogYWNjLnJlcFxuICAgIH07XG4gIH1cbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9jZXNzVGVtcGxhdGUodGVtcCwgaW50ZXJwID0gTGlzdCgpKSB7XG4gIHJldHVybiB0ZW1wLnJlZHVjZShwcm9jZXNzLCB7IHRlbXBsYXRlOiBMaXN0KCksIGludGVycCB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VUZW1wbGF0ZSh0ZW1wLCByZXApIHtcbiAgcmV0dXJuIHRlbXAucmVkdWNlKHJlcGxhY2UsIHsgdGVtcGxhdGU6IExpc3QoKSwgcmVwIH0pLnRlbXBsYXRlO1xufVxuIl19