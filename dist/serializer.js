"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.serializer = exports.makeDeserializer = undefined;

var _transitJs = require("transit-js");

var _transitJs2 = _interopRequireDefault(_transitJs);

var _immutable = require("immutable");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _symbol = require("./symbol");

var _tokenizer = require("shift-parser/dist/tokenizer");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let typeMap = [_tokenizer.TokenType.STRING, _tokenizer.TokenType.EOS, _tokenizer.TokenType.LPAREN, _tokenizer.TokenType.RPAREN, _tokenizer.TokenType.LBRACK, _tokenizer.TokenType.RBRACK, _tokenizer.TokenType.LBRACE, _tokenizer.TokenType.RBRACE, _tokenizer.TokenType.COLON, _tokenizer.TokenType.SEMICOLON, _tokenizer.TokenType.PERIOD, _tokenizer.TokenType.ELLIPSIS, _tokenizer.TokenType.ARROW, _tokenizer.TokenType.CONDITIONAL, _tokenizer.TokenType.INC, _tokenizer.TokenType.DEC, _tokenizer.TokenType.ASSIGN, _tokenizer.TokenType.ASSIGN_BIT_OR, _tokenizer.TokenType.ASSIGN_BIT_XOR, _tokenizer.TokenType.ASSIGN_BIT_AND, _tokenizer.TokenType.ASSIGN_SHL, _tokenizer.TokenType.ASSIGN_SHR, _tokenizer.TokenType.ASSIGN_SHR_UNSIGNED, _tokenizer.TokenType.ASSIGN_ADD, _tokenizer.TokenType.ASSIGN_SUB, _tokenizer.TokenType.ASSIGN_MUL, _tokenizer.TokenType.ASSIGN_DIV, _tokenizer.TokenType.ASSIGN_MOD, _tokenizer.TokenType.COMMA, _tokenizer.TokenType.OR, _tokenizer.TokenType.AND, _tokenizer.TokenType.BIT_OR, _tokenizer.TokenType.BIT_XOR, _tokenizer.TokenType.BIT_AND, _tokenizer.TokenType.SHL, _tokenizer.TokenType.SHR, _tokenizer.TokenType.SHR_UNSIGNED, _tokenizer.TokenType.ADD, _tokenizer.TokenType.SUB, _tokenizer.TokenType.MUL, _tokenizer.TokenType.DIV, _tokenizer.TokenType.MOD, _tokenizer.TokenType.EQ, _tokenizer.TokenType.NE, _tokenizer.TokenType.EQ_STRICT, _tokenizer.TokenType.NE_STRICT, _tokenizer.TokenType.LT, _tokenizer.TokenType.GT, _tokenizer.TokenType.LTE, _tokenizer.TokenType.GTE, _tokenizer.TokenType.INSTANCEOF, _tokenizer.TokenType.IN, _tokenizer.TokenType.NOT, _tokenizer.TokenType.BIT_NOT, _tokenizer.TokenType.AWAIT, _tokenizer.TokenType.DELETE, _tokenizer.TokenType.TYPEOF, _tokenizer.TokenType.VOID, _tokenizer.TokenType.BREAK, _tokenizer.TokenType.CASE, _tokenizer.TokenType.CATCH, _tokenizer.TokenType.CLASS, _tokenizer.TokenType.CONTINUE, _tokenizer.TokenType.DEBUGGER, _tokenizer.TokenType.DEFAULT, _tokenizer.TokenType.DO, _tokenizer.TokenType.ELSE, _tokenizer.TokenType.EXPORT, _tokenizer.TokenType.EXTENDS, _tokenizer.TokenType.FINALLY, _tokenizer.TokenType.FOR, _tokenizer.TokenType.FUNCTION, _tokenizer.TokenType.IF, _tokenizer.TokenType.IMPORT, _tokenizer.TokenType.LET, _tokenizer.TokenType.NEW, _tokenizer.TokenType.RETURN, _tokenizer.TokenType.SUPER, _tokenizer.TokenType.SWITCH, _tokenizer.TokenType.THIS, _tokenizer.TokenType.THROW, _tokenizer.TokenType.TRY, _tokenizer.TokenType.VAR, _tokenizer.TokenType.WHILE, _tokenizer.TokenType.WITH, _tokenizer.TokenType.NULL, _tokenizer.TokenType.TRUE, _tokenizer.TokenType.FALSE, _tokenizer.TokenType.YIELD, _tokenizer.TokenType.NUMBER, _tokenizer.TokenType.STRING, _tokenizer.TokenType.REGEXP, _tokenizer.TokenType.IDENTIFIER, _tokenizer.TokenType.CONST, _tokenizer.TokenType.TEMPLATE, _tokenizer.TokenType.ILLEGAL];

let ListHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "array",
  rep: v => v
});

let MapHandler = _transitJs2.default.makeWriteHandler({
  tag: function tag() {
    return "map";
  },
  rep: function rep(v) {
    return v;
  },
  stringRep: function stringRep() {
    return null;
  }
});

let SyntaxHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "stx",
  rep: v => {
    if (_immutable.List.isList(v.token)) {
      return [v.token, v.scopesets];
    } else {
      let t = _transitJs2.default.objectToMap(v.token);
      t.set("type", typeMap.indexOf(v.token.type));
      return [t, v.scopesets];
    }
  }
});
let SymbolHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "symb",
  rep: v => [v.name]
});

let writer = _transitJs2.default.writer("json", {
  handlers: _transitJs2.default.map([_immutable.List, ListHandler, _immutable.Map, MapHandler, _syntax2.default, SyntaxHandler, _symbol.SymbolClass, SymbolHandler])
});

function makeReader(bindings) {
  return _transitJs2.default.reader("json", {
    arrayBuilder: {
      init: () => (0, _immutable.List)().asMutable(),
      add: (ret, val) => ret.push(val),
      finalize: ret => ret.asImmutable(),
      fromArray: arr => (0, _immutable.List)(arr)
    },
    mapBuilder: {
      init: function init() {
        return (0, _immutable.Map)().asMutable();
      },
      add: function add(ret, key, val) {
        return ret.set(key, val);
      },
      finalize: function finalize(ret) {
        return ret.asImmutable();
      }
    },
    handlers: {
      "stx": rep => {
        let scopesets = _transitJs2.default.mapToObject(rep[1]);
        if (_immutable.List.isList(rep[0])) {
          let token = rep[0];
          return new _syntax2.default(token, { bindings: bindings, scopesets: scopesets });
        } else {
          let token = _transitJs2.default.mapToObject(rep[0]);
          token.type = typeMap[rep[0].get("type")];
          token.slice = rep[0].has("slice") ? _transitJs2.default.mapToObject(rep[0].get("slice")) : undefined;
          if (token.slice) {
            token.slice.startLocation = _transitJs2.default.mapToObject(token.slice.startLocation);
          }
          return new _syntax2.default(token, { bindings: bindings, scopesets: scopesets });
        }
      },
      "symb": rep => {
        return (0, _symbol.Symbol)(rep[0]);
      }
    }
  });
}

exports.makeDeserializer = makeReader;
exports.serializer = writer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJpYWxpemVyLmpzIl0sIm5hbWVzIjpbInR5cGVNYXAiLCJTVFJJTkciLCJFT1MiLCJMUEFSRU4iLCJSUEFSRU4iLCJMQlJBQ0siLCJSQlJBQ0siLCJMQlJBQ0UiLCJSQlJBQ0UiLCJDT0xPTiIsIlNFTUlDT0xPTiIsIlBFUklPRCIsIkVMTElQU0lTIiwiQVJST1ciLCJDT05ESVRJT05BTCIsIklOQyIsIkRFQyIsIkFTU0lHTiIsIkFTU0lHTl9CSVRfT1IiLCJBU1NJR05fQklUX1hPUiIsIkFTU0lHTl9CSVRfQU5EIiwiQVNTSUdOX1NITCIsIkFTU0lHTl9TSFIiLCJBU1NJR05fU0hSX1VOU0lHTkVEIiwiQVNTSUdOX0FERCIsIkFTU0lHTl9TVUIiLCJBU1NJR05fTVVMIiwiQVNTSUdOX0RJViIsIkFTU0lHTl9NT0QiLCJDT01NQSIsIk9SIiwiQU5EIiwiQklUX09SIiwiQklUX1hPUiIsIkJJVF9BTkQiLCJTSEwiLCJTSFIiLCJTSFJfVU5TSUdORUQiLCJBREQiLCJTVUIiLCJNVUwiLCJESVYiLCJNT0QiLCJFUSIsIk5FIiwiRVFfU1RSSUNUIiwiTkVfU1RSSUNUIiwiTFQiLCJHVCIsIkxURSIsIkdURSIsIklOU1RBTkNFT0YiLCJJTiIsIk5PVCIsIkJJVF9OT1QiLCJBV0FJVCIsIkRFTEVURSIsIlRZUEVPRiIsIlZPSUQiLCJCUkVBSyIsIkNBU0UiLCJDQVRDSCIsIkNMQVNTIiwiQ09OVElOVUUiLCJERUJVR0dFUiIsIkRFRkFVTFQiLCJETyIsIkVMU0UiLCJFWFBPUlQiLCJFWFRFTkRTIiwiRklOQUxMWSIsIkZPUiIsIkZVTkNUSU9OIiwiSUYiLCJJTVBPUlQiLCJMRVQiLCJORVciLCJSRVRVUk4iLCJTVVBFUiIsIlNXSVRDSCIsIlRISVMiLCJUSFJPVyIsIlRSWSIsIlZBUiIsIldISUxFIiwiV0lUSCIsIk5VTEwiLCJUUlVFIiwiRkFMU0UiLCJZSUVMRCIsIk5VTUJFUiIsIlJFR0VYUCIsIklERU5USUZJRVIiLCJDT05TVCIsIlRFTVBMQVRFIiwiSUxMRUdBTCIsIkxpc3RIYW5kbGVyIiwibWFrZVdyaXRlSGFuZGxlciIsInRhZyIsInJlcCIsInYiLCJNYXBIYW5kbGVyIiwic3RyaW5nUmVwIiwiU3ludGF4SGFuZGxlciIsImlzTGlzdCIsInRva2VuIiwic2NvcGVzZXRzIiwidCIsIm9iamVjdFRvTWFwIiwic2V0IiwiaW5kZXhPZiIsInR5cGUiLCJTeW1ib2xIYW5kbGVyIiwibmFtZSIsIndyaXRlciIsImhhbmRsZXJzIiwibWFwIiwibWFrZVJlYWRlciIsImJpbmRpbmdzIiwicmVhZGVyIiwiYXJyYXlCdWlsZGVyIiwiaW5pdCIsImFzTXV0YWJsZSIsImFkZCIsInJldCIsInZhbCIsInB1c2giLCJmaW5hbGl6ZSIsImFzSW1tdXRhYmxlIiwiZnJvbUFycmF5IiwiYXJyIiwibWFwQnVpbGRlciIsImtleSIsIm1hcFRvT2JqZWN0IiwiZ2V0Iiwic2xpY2UiLCJoYXMiLCJ1bmRlZmluZWQiLCJzdGFydExvY2F0aW9uIiwibWFrZURlc2VyaWFsaXplciIsInNlcmlhbGl6ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxJQUFJQSxVQUFVLENBQUMscUJBQVVDLE1BQVgsRUFBbUIscUJBQVVDLEdBQTdCLEVBQWtDLHFCQUFVQyxNQUE1QyxFQUFvRCxxQkFBVUMsTUFBOUQsRUFDQyxxQkFBVUMsTUFEWCxFQUNtQixxQkFBVUMsTUFEN0IsRUFDcUMscUJBQVVDLE1BRC9DLEVBQ3VELHFCQUFVQyxNQURqRSxFQUVDLHFCQUFVQyxLQUZYLEVBRWtCLHFCQUFVQyxTQUY1QixFQUV1QyxxQkFBVUMsTUFGakQsRUFFeUQscUJBQVVDLFFBRm5FLEVBR0MscUJBQVVDLEtBSFgsRUFHa0IscUJBQVVDLFdBSDVCLEVBR3lDLHFCQUFVQyxHQUhuRCxFQUd3RCxxQkFBVUMsR0FIbEUsRUFJQyxxQkFBVUMsTUFKWCxFQUltQixxQkFBVUMsYUFKN0IsRUFJNEMscUJBQVVDLGNBSnRELEVB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Q0FBb0I1QixNQUFNOEIsS0FBTixDQUFZRyxhQUFoQyxDQUE1QjtBQUNEO0FBQ0QsaUJBQU8scUJBQVdqQyxLQUFYLEVBQWtCLEVBQUNhLGtCQUFELEVBQVdaLFdBQVdBLFNBQXRCLEVBQWxCLENBQVA7QUFDRDtBQUNGLE9BZk87QUFnQlIsY0FBU1AsR0FBRCxJQUFTO0FBQ2YsZUFBTyxvQkFBT0EsSUFBSSxDQUFKLENBQVAsQ0FBUDtBQUNEO0FBbEJPO0FBWmtCLEdBQXZCLENBQVA7QUFpQ0Q7O1FBR2V3QyxnQixHQUFkdEIsVTtRQUEwQ3VCLFUsR0FBVjFCLE0iLCJmaWxlIjoic2VyaWFsaXplci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0cmFuc2l0IGZyb20gXCJ0cmFuc2l0LWpzXCI7XG5pbXBvcnQgeyBMaXN0LCBNYXAgfSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgU3ludGF4IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IHsgU3ltYm9sLCAgU3ltYm9sQ2xhc3MgfSBmcm9tIFwiLi9zeW1ib2xcIjtcbmltcG9ydCB7IFRva2VuVHlwZSB9IGZyb20gXCJzaGlmdC1wYXJzZXIvZGlzdC90b2tlbml6ZXJcIjtcblxubGV0IHR5cGVNYXAgPSBbVG9rZW5UeXBlLlNUUklORywgVG9rZW5UeXBlLkVPUywgVG9rZW5UeXBlLkxQQVJFTiwgVG9rZW5UeXBlLlJQQVJFTixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5MQlJBQ0ssIFRva2VuVHlwZS5SQlJBQ0ssIFRva2VuVHlwZS5MQlJBQ0UsIFRva2VuVHlwZS5SQlJBQ0UsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuQ09MT04sIFRva2VuVHlwZS5TRU1JQ09MT04sIFRva2VuVHlwZS5QRVJJT0QsIFRva2VuVHlwZS5FTExJUFNJUyxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5BUlJPVywgVG9rZW5UeXBlLkNPTkRJVElPTkFMLCBUb2tlblR5cGUuSU5DLCBUb2tlblR5cGUuREVDLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkFTU0lHTiwgVG9rZW5UeXBlLkFTU0lHTl9CSVRfT1IsIFRva2VuVHlwZS5BU1NJR05fQklUX1hPUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5BU1NJR05fQklUX0FORCwgVG9rZW5UeXBlLkFTU0lHTl9TSEwsIFRva2VuVHlwZS5BU1NJR05fU0hSLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkFTU0lHTl9TSFJfVU5TSUdORUQsIFRva2VuVHlwZS5BU1NJR05fQURELCBUb2tlblR5cGUuQVNTSUdOX1NVQixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5BU1NJR05fTVVMLCBUb2tlblR5cGUuQVNTSUdOX0RJViwgVG9rZW5UeXBlLkFTU0lHTl9NT0QsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuQ09NTUEsIFRva2VuVHlwZS5PUiwgVG9rZW5UeXBlLkFORCwgVG9rZW5UeXBlLkJJVF9PUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5CSVRfWE9SLCBUb2tlblR5cGUuQklUX0FORCwgVG9rZW5UeXBlLlNITCwgVG9rZW5UeXBlLlNIUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5TSFJfVU5TSUdORUQsIFRva2VuVHlwZS5BREQsIFRva2VuVHlwZS5TVUIsIFRva2VuVHlwZS5NVUwsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuRElWLCBUb2tlblR5cGUuTU9ELCBUb2tlblR5cGUuRVEsIFRva2VuVHlwZS5ORSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5FUV9TVFJJQ1QsIFRva2VuVHlwZS5ORV9TVFJJQ1QsIFRva2VuVHlwZS5MVCwgVG9rZW5UeXBlLkdULFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkxURSwgVG9rZW5UeXBlLkdURSwgVG9rZW5UeXBlLklOU1RBTkNFT0YsIFRva2VuVHlwZS5JTixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5OT1QsIFRva2VuVHlwZS5CSVRfTk9ULCBUb2tlblR5cGUuQVdBSVQsIFRva2VuVHlwZS5ERUxFVEUsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuVFlQRU9GLCBUb2tlblR5cGUuVk9JRCwgVG9rZW5UeXBlLkJSRUFLLCBUb2tlblR5cGUuQ0FTRSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5DQVRDSCwgVG9rZW5UeXBlLkNMQVNTLCBUb2tlblR5cGUuQ09OVElOVUUsIFRva2VuVHlwZS5ERUJVR0dFUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5ERUZBVUxULCBUb2tlblR5cGUuRE8sIFRva2VuVHlwZS5FTFNFLCBUb2tlblR5cGUuRVhQT1JULFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkVYVEVORFMsIFRva2VuVHlwZS5GSU5BTExZLCBUb2tlblR5cGUuRk9SLCBUb2tlblR5cGUuRlVOQ1RJT04sXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuSUYsIFRva2VuVHlwZS5JTVBPUlQsIFRva2VuVHlwZS5MRVQsIFRva2VuVHlwZS5ORVcsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuUkVUVVJOLCBUb2tlblR5cGUuU1VQRVIsIFRva2VuVHlwZS5TV0lUQ0gsIFRva2VuVHlwZS5USElTLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLlRIUk9XLCBUb2tlblR5cGUuVFJZLCBUb2tlblR5cGUuVkFSLCBUb2tlblR5cGUuV0hJTEUsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuV0lUSCwgVG9rZW5UeXBlLk5VTEwsIFRva2VuVHlwZS5UUlVFLCBUb2tlblR5cGUuRkFMU0UsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuWUlFTEQsIFRva2VuVHlwZS5OVU1CRVIsIFRva2VuVHlwZS5TVFJJTkcsIFRva2VuVHlwZS5SRUdFWFAsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuSURFTlRJRklFUiwgVG9rZW5UeXBlLkNPTlNULCBUb2tlblR5cGUuVEVNUExBVEUsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuSUxMRUdBTF07XG5cbmxldCBMaXN0SGFuZGxlciA9IHRyYW5zaXQubWFrZVdyaXRlSGFuZGxlcih7XG4gIHRhZzogKCkgPT4gXCJhcnJheVwiLFxuICByZXA6ICh2KSA9PiB2XG59KTtcblxubGV0IE1hcEhhbmRsZXIgPSB0cmFuc2l0Lm1ha2VXcml0ZUhhbmRsZXIoe1xuICB0YWc6IGZ1bmN0aW9uKCkgeyByZXR1cm4gXCJtYXBcIjsgfSxcbiAgcmVwOiBmdW5jdGlvbih2KSB7IHJldHVybiB2OyB9LFxuICBzdHJpbmdSZXA6IGZ1bmN0aW9uKCkgeyByZXR1cm4gbnVsbDsgfVxufSk7XG5cbmxldCBTeW50YXhIYW5kbGVyID0gdHJhbnNpdC5tYWtlV3JpdGVIYW5kbGVyKHtcbiAgdGFnOiAoKSA9PiBcInN0eFwiLFxuICByZXA6ICh2KSA9PiB7XG4gICAgaWYgKExpc3QuaXNMaXN0KHYudG9rZW4pKSB7XG4gICAgICByZXR1cm4gW3YudG9rZW4sIHYuc2NvcGVzZXRzXTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHQgPSB0cmFuc2l0Lm9iamVjdFRvTWFwKHYudG9rZW4pO1xuICAgICAgdC5zZXQoXCJ0eXBlXCIsIHR5cGVNYXAuaW5kZXhPZih2LnRva2VuLnR5cGUpKTtcbiAgICAgIHJldHVybiBbdCwgdi5zY29wZXNldHNdO1xuICAgIH1cbiAgfVxufSk7XG5sZXQgU3ltYm9sSGFuZGxlciA9IHRyYW5zaXQubWFrZVdyaXRlSGFuZGxlcih7XG4gIHRhZzogKCkgPT4gXCJzeW1iXCIsXG4gIHJlcDogKHYpID0+ICBbdi5uYW1lXVxufSk7XG5cbmxldCB3cml0ZXIgPSB0cmFuc2l0LndyaXRlcihcImpzb25cIiwge1xuICBoYW5kbGVyczogdHJhbnNpdC5tYXAoW1xuICAgIExpc3QsIExpc3RIYW5kbGVyLFxuICAgIE1hcCwgTWFwSGFuZGxlcixcbiAgICBTeW50YXgsIFN5bnRheEhhbmRsZXIsXG4gICAgU3ltYm9sQ2xhc3MsIFN5bWJvbEhhbmRsZXJcbiAgXSlcbn0pO1xuXG5mdW5jdGlvbiBtYWtlUmVhZGVyKGJpbmRpbmdzKSB7XG4gIHJldHVybiB0cmFuc2l0LnJlYWRlcihcImpzb25cIiwge1xuICAgIGFycmF5QnVpbGRlcjoge1xuICAgICAgaW5pdDogKCkgPT4gTGlzdCgpLmFzTXV0YWJsZSgpLFxuICAgICAgYWRkOiAocmV0LCB2YWwpID0+IHJldC5wdXNoKHZhbCksXG4gICAgICBmaW5hbGl6ZTogKHJldCkgPT4gcmV0LmFzSW1tdXRhYmxlKCksXG4gICAgICBmcm9tQXJyYXk6IChhcnIpID0+IExpc3QoYXJyKVxuICAgIH0sXG4gICAgbWFwQnVpbGRlcjoge1xuICAgICAgaW5pdDogZnVuY3Rpb24oKSB7IHJldHVybiBNYXAoKS5hc011dGFibGUoKTsgfSxcbiAgICAgIGFkZDogZnVuY3Rpb24ocmV0LCBrZXksIHZhbCkgeyByZXR1cm4gcmV0LnNldChrZXksIHZhbCk7IH0sXG4gICAgICBmaW5hbGl6ZTogZnVuY3Rpb24ocmV0KSB7IHJldHVybiByZXQuYXNJbW11dGFibGUoKTsgfVxuICAgIH0sXG4gICAgaGFuZGxlcnM6IHtcbiAgICAgIFwic3R4XCI6IChyZXApID0+IHtcbiAgICAgICAgbGV0IHNjb3Blc2V0cyA9IHRyYW5zaXQubWFwVG9PYmplY3QocmVwWzFdKTtcbiAgICAgICAgaWYgKExpc3QuaXNMaXN0KHJlcFswXSkpIHtcbiAgICAgICAgICBsZXQgdG9rZW4gPSByZXBbMF07XG4gICAgICAgICAgcmV0dXJuIG5ldyBTeW50YXgodG9rZW4sIHtiaW5kaW5ncywgc2NvcGVzZXRzOiBzY29wZXNldHN9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsZXQgdG9rZW4gPSB0cmFuc2l0Lm1hcFRvT2JqZWN0KHJlcFswXSk7XG4gICAgICAgICAgdG9rZW4udHlwZSA9IHR5cGVNYXBbcmVwWzBdLmdldChcInR5cGVcIildO1xuICAgICAgICAgIHRva2VuLnNsaWNlID0gcmVwWzBdLmhhcyhcInNsaWNlXCIpID8gdHJhbnNpdC5tYXBUb09iamVjdChyZXBbMF0uZ2V0KFwic2xpY2VcIikpIDogdW5kZWZpbmVkO1xuICAgICAgICAgIGlmICh0b2tlbi5zbGljZSkge1xuICAgICAgICAgICAgdG9rZW4uc2xpY2Uuc3RhcnRMb2NhdGlvbiA9IHRyYW5zaXQubWFwVG9PYmplY3QodG9rZW4uc2xpY2Uuc3RhcnRMb2NhdGlvbik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBuZXcgU3ludGF4KHRva2VuLCB7YmluZGluZ3MsIHNjb3Blc2V0czogc2NvcGVzZXRzfSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBcInN5bWJcIjogKHJlcCkgPT4ge1xuICAgICAgICByZXR1cm4gU3ltYm9sKHJlcFswXSk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuZXhwb3J0IHtcbiAgbWFrZVJlYWRlciBhcyBtYWtlRGVzZXJpYWxpemVyLCB3cml0ZXIgYXMgc2VyaWFsaXplclxufTtcbiJdfQ==